# WebAssemblyCanvas

# How to run it

Firstly, install the dependencies running `yarn`
After that, start the server running `yarn start` and type the address `http://localhost:2222` at the browser navigation bar.

# How does it work

## В общих чертах.
Это форкнутая версия демо, написанного на языке Си. Я переписал на C++ и добавил описание к проекту.

Файл `lib/canvac.c` содержит в себе определение структур кругов с их положением, скоростью движения и цветом. 
Также тут содержится тяжелая логика по пересчитыванию положения для всех кругов из списка.

Код JS в файле `public/index.html` содержит в себе определение канваса и логику рендера, 
который рисует подсчитанные положения кругов на самом канвасе. Код JS никак не влияет на сами данные, только рисование.

Иными словами - движок в коде, который компилируется в wasm файл, взаимодействие с браузером - в коде JS.

## Подробнее

### Команда на запуск компиляции
`em++ ./lib/canvas.cpp -O2 -s WASM=1 -s EXPORTED_FUNCTIONS="['_getCircles', '_main']" -o ./public/canvas_cpp.js -s ERROR_ON_UNDEFINED_SYMBOLS=0`

### [lib/canvas.cpp](./lib/canvas.cpp)

В этом файле задаются структуры данных для круга `Circle` и для состояния анимации каждого круга `CircleAnimationData`.

В методе `main()` происходит начальная инициализация двух массивов с данными - круги и состояния анимации.
В том же методе происходит вызов JS функции `render`.

Метод `getCircles()` просчитывает изменения в состоянии всех кругов и возвращает указатель на массив `circles`, 
по адресу которого JS код уже считывает данные.

Интересный момент - в структуре `Circle` 6 полей, и каждое из этих полей становится элементом общего буфера данных.
Поэтому в коде JS для каждого отдельного круга нужно делать сдвиг на 6 - количество полей в структуре.

### [public/index.html](./public/index.html)

В коде JS определяется функция `render`, которая отвечает за запрос списка кругов с уровня wasm (из буфера общей памяти),
а также отображает эти круги на канвасе, используя настройки радиуса и цвета из структуры данных. Все просто.

Интересным момент тут является то, как считываются данные из буфера. Как я упоминал выше - в структуре `Circle` каждый объект
имеет 6 полей, а значит один круг - это 6 элементов массива, каждое свойство - отдельный элемент массива. 
Тут надо быть внимательным при такой работе с данными, чтобы не перепутать поля.

Отдельный момент тут то, что после инициализации wasm необходимо запустить руками стартовый метод `main()` и сохранить ссылку
на экспорты из инстанса wasm, чтобы использовать в методе render.

### Заключение
- На мой взгляд, этот проект - чудесная демонстрация того, как подружить канвас с c++ wasm, дальше можно поиграться с логикой движения
  кругов, например чтобы круги обходили друг дружку на каком-то расстоянии, чтобы большие отодвигали маленьких, и все в
  таком духе.
- Также это замечательный пример работы с данными, видно как они кладутся в буфер и достаются оттуда.
- Рекомендую обязательно попробовать поменять число кругов, которые рисуются. Я вместо изначальных 100 сделал 1000 
и результат весьма забавный.
- Также можно поиграться с размерами кругов, чем меньше круги - тем лучше рисуется их количество.

#### В ролях
- html canvas ('2d' context)
- C++ (.cpp)
- Web Assembly (.wasm)
- express.js
